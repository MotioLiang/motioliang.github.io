import{_ as s,c as a,e as p,o as t}from"./app-DKLT9RiB.js";const e={};function o(c,n){return t(),a("div",null,n[0]||(n[0]=[p(`<h3 id="aliyun-oss-sdk-引入" tabindex="-1"><a class="header-anchor" href="#aliyun-oss-sdk-引入"><span>aliyun-oss-sdk 引入</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line"><span class="token function">yarn</span> <span class="token function">add</span> ali-oss</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="创建工具-在-utils-目录下新增-oss-js" tabindex="-1"><a class="header-anchor" href="#创建工具-在-utils-目录下新增-oss-js"><span>创建工具，在 utils 目录下新增 oss.js</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> getststoken<span class="token punctuation">,</span> getuploadconfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/api/index.js&#39;</span></span>
<span class="line"><span class="token keyword">import</span> md5 <span class="token keyword">from</span> <span class="token string">&#39;js-md5&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> Message <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;element-ui&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token constant">OSS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;ali-oss&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">oss</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">OSS</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// oss 实例</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ossClient</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> config <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">getststoken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getuploadconfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">let</span> tokenData <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data</span>
<span class="line">                <span class="token keyword">let</span> configData <span class="token operator">=</span> res<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data</span>
<span class="line"></span>
<span class="line">                <span class="token comment">// 接口失败跳出</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token number">200</span> <span class="token operator">||</span> tokenData<span class="token punctuation">.</span>ret_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    Message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;服务异常，稍后请重试&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">!=</span> <span class="token number">200</span> <span class="token operator">||</span> configData<span class="token punctuation">.</span>ret_code <span class="token operator">!=</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                    Message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;服务异常，稍后请重试&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">// oss参数</span></span>
<span class="line">                <span class="token keyword">const</span> <span class="token punctuation">{</span> Credentials <span class="token punctuation">}</span> <span class="token operator">=</span> tokenData<span class="token punctuation">.</span>result</span>
<span class="line">                <span class="token keyword">const</span> singleConfig <span class="token operator">=</span> configData<span class="token punctuation">.</span>result<span class="token punctuation">[</span>config<span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">                    <span class="token literal-property property">region</span><span class="token operator">:</span> <span class="token string">&#39;oss-cn-beijing&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">stsToken</span><span class="token operator">:</span> Credentials<span class="token punctuation">.</span>SecurityToken<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">accessKeyId</span><span class="token operator">:</span> Credentials<span class="token punctuation">.</span>AccessKeyId<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">accessKeySecret</span><span class="token operator">:</span> Credentials<span class="token punctuation">.</span>AccessKeySecret<span class="token punctuation">,</span></span>
<span class="line">                    <span class="token literal-property property">bucket</span><span class="token operator">:</span> singleConfig<span class="token punctuation">.</span>bucket</span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token function">oss</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> client<span class="token punctuation">,</span> <span class="token literal-property property">configData</span><span class="token operator">:</span> singleConfig <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">                Message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;服务异常，稍后请重试&#39;</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 名称加密</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setMd5Path</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> array <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">let</span> type <span class="token operator">=</span> array<span class="token punctuation">[</span>array<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">let</span> fileName <span class="token operator">=</span> <span class="token string">&#39;&#39;</span></span>
<span class="line">    array<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!==</span> array<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            fileName <span class="token operator">+=</span> value</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">md5</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="页面内调用" tabindex="-1"><a class="header-anchor" href="#页面内调用"><span>页面内调用</span></a></h3><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> ossClient<span class="token punctuation">,</span> setMd5Path <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@/utils/oss&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 上传文件到oss</span></span>
<span class="line"><span class="token function">uploadFileInOss</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> file <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token string">&#39;diagnosis_treat&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">	<span class="token function">ossClient</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> client<span class="token punctuation">,</span> configData <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">		<span class="token keyword">let</span> filePath <span class="token operator">=</span> <span class="token function">setMd5Path</span><span class="token punctuation">(</span>configData<span class="token punctuation">.</span>pre<span class="token punctuation">,</span> file<span class="token punctuation">.</span>name<span class="token punctuation">)</span></span>
<span class="line">		client</span>
<span class="line">			<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> file<span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ossRes</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setFileList</span><span class="token punctuation">(</span>ossRes<span class="token punctuation">,</span> file<span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">				<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&#39;上传异常，稍后请重试&#39;</span><span class="token punctuation">)</span></span>
<span class="line">			<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 下载oss文件</span></span>
<span class="line"><span class="token function">downloadFileInOss</span><span class="token punctuation">(</span><span class="token parameter">url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token string">&#39;diagnosis_treat&#39;</span> <span class="token punctuation">}</span></span>
<span class="line">	<span class="token function">ossClient</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> client <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 预览路径</span></span>
<span class="line">		<span class="token keyword">let</span> filePath <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">signatureUrl</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">	<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6)]))}const i=s(e,[["render",o],["__file","oss.html.vue"]]),u=JSON.parse('{"path":"/blogs/vue/oss.html","title":"vue+oss 上传/下载文件","lang":"en-US","frontmatter":{"title":"vue+oss 上传/下载文件","date":"2021-02-21T00:00:00.000Z","tags":["vue","oss"],"categories":["vue"]},"headers":[{"level":3,"title":"aliyun-oss-sdk 引入","slug":"aliyun-oss-sdk-引入","link":"#aliyun-oss-sdk-引入","children":[]},{"level":3,"title":"创建工具，在 utils 目录下新增 oss.js","slug":"创建工具-在-utils-目录下新增-oss-js","link":"#创建工具-在-utils-目录下新增-oss-js","children":[]},{"level":3,"title":"页面内调用","slug":"页面内调用","link":"#页面内调用","children":[]}],"git":{"createdTime":1639637702000,"updatedTime":1639637702000,"contributors":[{"name":"王浩亮","email":"wanghaoliang@epatient.cn","commits":1}]},"filePathRelative":"blogs/vue/oss.md"}');export{i as comp,u as data};
